<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Auto Cam</title>
    <script src="https://cdn.jsdelivr.net/npm/streamlit-component-lib@2.0.0/dist/streamlit-component-lib.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: sans-serif;
        background: transparent;
      }
      #root {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 4px;
      }
      video {
        width: 100%;
        max-width: 640px;
        border-radius: 10px;
        background: #000;
      }
      canvas {
        display: none;
      }
      #cap-btn {
        padding: 14px 32px;
        font-size: 1.05rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        font-weight: bold;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
        transition: all 0.15s;
      }
      #cap-btn:active,
      #cap-btn.active {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        transform: scale(0.97);
      }
      #status {
        font-size: 0.9rem;
        color: #888;
      }
    </style>
  </head>
  <body>
    <div id="root">
      <video id="vid" autoplay playsinline muted></video>
      <button id="cap-btn">ðŸ“· Tahan untuk Capture (atau tahan Spasi)</button>
      <div id="status">0 foto captured</div>
      <canvas id="cvs"></canvas>
    </div>
    <script>
      (function () {
        const Streamlit = window.Streamlit;
        Streamlit.setFrameHeight();

        const vid = document.getElementById("vid");
        const btn = document.getElementById("cap-btn");
        const statusEl = document.getElementById("status");
        const cvs = document.getElementById("cvs");

        let capturing = false,
          timer = null,
          count = 0,
          frames = [];
        let intervalMs = 300;

        Streamlit.events.addEventListener(Streamlit.RENDER_EVENT, (event) => {
          const data = event.detail;
          if (data.args.interval_ms) intervalMs = data.args.interval_ms;
          if (data.args.label) btn.textContent = data.args.label;
          Streamlit.setFrameHeight();
        });

        navigator.mediaDevices
          .getUserMedia({
            video: {
              facingMode: "environment",
              width: { ideal: 640 },
              height: { ideal: 480 },
            },
          })
          .then((s) => {
            vid.srcObject = s;
          })
          .catch((e) => {
            statusEl.textContent = "Kamera error: " + e.message;
          });

        function captureOne() {
          if (vid.readyState < 2) return;
          cvs.width = vid.videoWidth;
          cvs.height = vid.videoHeight;
          cvs.getContext("2d").drawImage(vid, 0, 0);
          frames.push(cvs.toDataURL("image/jpeg", 0.85));
          count++;
          statusEl.textContent = count + " foto captured";
          btn.textContent = "ðŸ”´ Capturing... (" + count + ")";
          btn.classList.add("active");
        }

        function startCapture() {
          if (capturing) return;
          capturing = true;
          captureOne();
          timer = setInterval(captureOne, intervalMs);
        }

        function stopCapture() {
          if (!capturing) return;
          capturing = false;
          clearInterval(timer);
          timer = null;
          btn.classList.remove("active");
          btn.textContent = "ðŸ“· Tahan untuk Capture (atau tahan Spasi)";
          if (frames.length > 0) {
            Streamlit.setComponentValue(frames);
            frames = [];
          }
        }

        btn.addEventListener("mousedown", (e) => {
          e.preventDefault();
          startCapture();
        });
        btn.addEventListener("mouseup", stopCapture);
        btn.addEventListener("mouseleave", stopCapture);
        btn.addEventListener(
          "touchstart",
          (e) => {
            e.preventDefault();
            startCapture();
          },
          { passive: false },
        );
        btn.addEventListener("touchend", stopCapture);
        btn.addEventListener("touchcancel", stopCapture);
        document.addEventListener("keydown", (e) => {
          if (e.code === "Space" && !e.repeat) {
            e.preventDefault();
            startCapture();
          }
        });
        document.addEventListener("keyup", (e) => {
          if (e.code === "Space") {
            e.preventDefault();
            stopCapture();
          }
        });

        Streamlit.setComponentReady();
        Streamlit.setFrameHeight();
      })();
    </script>
  </body>
</html>
