<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>Live Cam</title>
<script src="https://cdn.jsdelivr.net/npm/streamlit-component-lib@2.0.0/dist/streamlit-component-lib.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:sans-serif;background:transparent}
#root{display:flex;flex-direction:column;align-items:center;gap:4px;padding:4px}
video{width:100%;max-width:640px;border-radius:10px;background:#000}
canvas{display:none}
#info{font-size:.85rem;color:#888}
</style>
</head>
<body>
<div id="root">
  <video id="vid" autoplay playsinline muted></video>
  <div id="info">Menunggu kamera...</div>
  <canvas id="cvs"></canvas>
</div>
<script>
(function(){
  const Streamlit = window.Streamlit;
  Streamlit.setFrameHeight();

  const vid = document.getElementById('vid');
  const info = document.getElementById('info');
  const cvs = document.getElementById('cvs');
  let intervalMs = 1500;
  let sendTimer = null;

  function startSending(){
    if(sendTimer) clearInterval(sendTimer);
    sendTimer = setInterval(()=>{
      if(vid.readyState>=2){
        cvs.width=vid.videoWidth; cvs.height=vid.videoHeight;
        cvs.getContext('2d').drawImage(vid,0,0);
        const dataUrl = cvs.toDataURL('image/jpeg',0.7);
        Streamlit.setComponentValue(dataUrl);
        info.textContent='ðŸ”´ Live â€” mengirim frame setiap '+(intervalMs/1000).toFixed(1)+'s';
      }
    }, intervalMs);
  }

  Streamlit.events.addEventListener(Streamlit.RENDER_EVENT, (event)=>{
    const data = event.detail;
    if(data.args.interval_ms) intervalMs = data.args.interval_ms;
    startSending();
    Streamlit.setFrameHeight();
  });

  navigator.mediaDevices.getUserMedia({
    video:{facingMode:'environment',width:{ideal:640},height:{ideal:480}}
  }).then(s=>{
    vid.srcObject=s;
    info.textContent='Kamera aktif. Menunggu interval pertama...';
  }).catch(e=>{info.textContent='Kamera error: '+e.message});

  Streamlit.setComponentReady();
  Streamlit.setFrameHeight();
})();
</script>
</body>
</html>
